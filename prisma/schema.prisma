generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  MENTOR
  ADMIN
}

enum VoteType {
  LIKE
  DISLIKE
}

enum MessageType {
  ANSWER_RECEIVED
  ANSWER_ACCEPTED
  ROLE_UPGRADED
  SYSTEM
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  firstName     String
  lastName      String
  phone         String?
  password      String
  role          Role      @default(USER)
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  verificationCodes VerificationCode[]
  userRoadmaps      UserRoadmap[]
  userProgress      UserProgress[]
  projects          Project[]
  projectFeedbacks  ProjectFeedback[]
  forumQuestions    ForumQuestion[]
  forumAnswers      ForumAnswer[]
  answerVotes       AnswerVote[]
  messages          Message[]
  blogComments      BlogComment[]
  blogBookmarks     BlogBookmark[]
  conversationsAsUser   ChatConversation[] @relation("UserConversations")
  conversationsAsMentor ChatConversation[] @relation("MentorConversations")
  chatMessagesSent      ChatMessage[]

  @@map("users")
}

enum ChatMessageType {
  TEXT
  IMAGE
  VOICE
  VIDEO
}

model ChatConversation {
  id        String   @id @default(cuid())
  userId    String
  mentorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation("UserConversations", fields: [userId], references: [id], onDelete: Cascade)
  mentor  User    @relation("MentorConversations", fields: [mentorId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@unique([userId, mentorId])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String         @id @default(cuid())
  conversationId String
  senderId       String
  type           ChatMessageType
  content        String         // متن یا caption
  fileUrl        String?        // لینک S3 برای تصویر/صدا/ویدیو
  replyToId      String?
  readAt         DateTime?
  createdAt      DateTime      @default(now())

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User             @relation(fields: [senderId], references: [id], onDelete: Cascade)
  replyTo      ChatMessage?     @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies       ChatMessage[]   @relation("MessageReplies")

  @@map("chat_messages")
}

model BlogComment {
  id        String   @id @default(cuid())
  blogSlug  String
  userId    String
  content   String
  status    CommentStatus @default(PENDING)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("blog_comments")
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
}

model BlogBookmark {
  id        String   @id @default(cuid())
  userId    String
  blogSlug  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, blogSlug])
  @@map("blog_bookmarks")
}

model VerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [email], references: [email], onDelete: Cascade)

  @@map("verification_codes")
}

model UserRoadmap {
  id           String   @id @default(cuid())
  userId       String
  roadmapSlug  String
  startedAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roadmapSlug])
  @@map("user_roadmaps")
}

model UserProgress {
  id          String   @id @default(cuid())
  userId      String
  roadmapSlug String
  stepId      String
  completed   Boolean  @default(true)
  completedAt DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roadmapSlug, stepId])
  @@map("user_progress")
}

model Project {
  id          String   @id @default(cuid())
  userId      String
  roadmapSlug String
  projectId   String
  repoUrl     String
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedbacks   ProjectFeedback[]

  @@unique([userId, roadmapSlug, projectId])
  @@map("projects")
}

model ProjectFeedback {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  content   String
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("project_feedbacks")
}

model Forum {
  id          String   @id @default(cuid())
  roadmapSlug String   @unique
  title       String
  createdAt   DateTime @default(now())
  questions   ForumQuestion[]

  @@map("forums")
}

model ForumQuestion {
  id        String   @id @default(cuid())
  forumId   String
  userId    String
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  forum     Forum    @relation(fields: [forumId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers   ForumAnswer[]

  @@map("forum_questions")
}

model ForumAnswer {
  id         String   @id @default(cuid())
  questionId String
  userId     String
  content    String
  isAccepted Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  question   ForumQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes      AnswerVote[]

  @@map("forum_answers")
}

model AnswerVote {
  id       String   @id @default(cuid())
  answerId String
  userId   String
  type     VoteType
  answer   ForumAnswer @relation(fields: [answerId], references: [id], onDelete: Cascade)
  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([answerId, userId])
  @@map("answer_votes")
}

model Message {
  id        String      @id @default(cuid())
  userId    String
  content   String
  read      Boolean     @default(false)
  type      MessageType
  link      String?
  createdAt DateTime    @default(now())
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("messages")
}
